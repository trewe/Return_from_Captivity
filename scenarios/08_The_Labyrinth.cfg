#textdomain wesnoth-Return_from_Captivity

[multiplayer]
    id=CSABI_The_Labyrinth
    next_scenario=CSABI_Open_Sesame
    name= _"RfC-The Labyrinth"
    map_data="{~add-ons/Return_from_Captivity/maps/08_The_Labyrinth.map}"
    description= _"A multi player campaign for 2 cooperative players. Bring home the elves and dwarfs from the troll prison."
    turns="70"
    victory_when_enemies_defeated=no
    experience_modifier=120%
    allow_new_game=no

    {INDOORS}
    {DEFAULT_MUSIC_PLAYLIST}

    [side]
        id=P1
        save_id=Player_1
        type=Elvish Captain
        side=1
        persistent=yes
        canrecruit=yes
        team_name="Allies"
        user_team_name= _"Allies"
        controller="human"
        team_lock=true
        gold_lock=true
        income_lock=true
        gold=200
        share_maps="yes"
        share_view="yes"
        recruit=Elvish Fighter,Elvish Archer,Mage,Elvish Shaman,Elvish Scout,Merman Fighter,Merman Hunter,Mermaid Initiate
        shroud=yes
        fog=yes
        village_gold=2
#ifhave campaigns/The_Rise_Of_Wesnoth
        profile="data/campaigns/The_Rise_Of_Wesnoth/images/portraits/logalmier.png"
#endif
    [/side]
    [side]
        id=P2
        save_id=Player_2
        persistent=yes
        type=Dwarvish Steelclad
        side=2
        canrecruit=yes
        team_name="Allies"
        user_team_name= _"Allies"
        controller="human"
        team_lock=true
        gold_lock=true
        income_lock=true
        share_maps="yes"
        share_view="yes"
        gold=200
        recruit=Dwarvish Guardsman,RfC Dwarvish Fighter,Dwarvish Scout,RfC Dwarvish Thunderer,RfC Alchemist,Merman Fighter,Merman Hunter,Mermaid Initiate
        shroud=yes
        fog=yes
        village_gold=2
#ifhave campaigns/Sceptre_of_Fire
        profile="data/campaigns/Sceptre_of_Fire/images/portraits/durstorn.png"
#endif
        [variables]
            dont_make_me_quick=yes
        [/variables]
    [/side]

    [side]
        type=Draug
        side=3
        canrecruit=yes
        controller=ai
        allow_player="no"
        team_name="Evils"
        user_team_name= _"Undead"
        gold=50
        income=16
        village_gold=1
        recruit=Skeleton,Skeleton Archer,Vampire Bat,Ghost,Blood Bat,Wraith,Revenant,Bone Shooter,Deathblade
        shroud=yes
        disallow_observers=yes
        [ai]
            village_value=0.0
            {NO_SCOUTS}
        [/ai]
    [/side]
    [side]
        type=Draug
        side=4
        canrecruit=yes
        controller=ai
        allow_player="no"
        team_name= "Evils"
        user_team_name= _"Undead"
        gold=50
        income=16
        village_gold=1
        recruit=Skeleton,Skeleton Archer,Vampire Bat,Ghost,Blood Bat,Wraith,Revenant,Bone Shooter,Deathblade
        shroud=yes
        disallow_observers=yes
        [ai]
            village_value=0.0
            {NO_SCOUTS}
        [/ai]
    [/side]

#define FOR_VAR VAR START END FOR_WML
    {VARIABLE {VAR} {START}}
    [while]
        {VARIABLE_CONDITIONAL {VAR} less_than {END}}
        [do]
            {FOR_WML}
            {VARIABLE_OP {VAR} add 1}
        [/do]
    [/while]
    {CLEAR_VARIABLE {VAR}}
#enddef

#define GENERATE_ENEMIES CNT SKELETONS
    {VARIABLE skels {SKELETONS}}
    {VARIABLE enemies 0}
    [while]
        {VARIABLE_CONDITIONAL enemies less_than_equal_to {CNT}}
        [do]
            [store_reachable_locations]
                [filter]
                    side=1
                    [or]
                        side=2
                    [/or]
                [/filter]
                range=vision
                variable=players_vision
            [/store_reachable_locations]

            [store_locations]
                {EVERYWHERE}
                [not]
                    terrain=X*,Q*,W*,K*,C*
                [/not]
                [not]
                    [filter]
                    [/filter]
                [/not]
                [not]
                    [filter_adjacent_location]
                        [filter]
                        [/filter]
                    [/filter_adjacent_location]
                [/not]
                [not]
                    find_in=players_vision
                [/not]
                variable=interested_loc
            [/store_locations]

            {RANDOM 1..$interested_loc.length}
            {VARIABLE_OP random sub 1}

            [if]
                {VARIABLE_CONDITIONAL interested_loc[$random].y greater_than 30}
                [then]
                    {VARIABLE enside 4}
                [/then]
                [else]
                    {VARIABLE enside 3}
                [/else]
            [/if]

            {VARIABLE_OP utyp rand 1..9}
            [if]
                {VARIABLE_CONDITIONAL skels equals yes}
                [then]
                    [switch]
                        variable=utyp
                        [case]
                            value=1,2
                            {VARIABLE utype "Bone Shooter"}
                        [/case]
                        [case]
                            value=3
                            {VARIABLE utype "Chocobone"}
                        [/case]
                        [case]
                            value=4,5,6,7
                            {VARIABLE utype "Deathblade"}
                        [/case]
                        [case]
                            value=8,9
                            {VARIABLE utype "Draug"}
                        [/case]
                    [/switch]
                    {GENERIC_UNIT $enside $utype $interested_loc[$random].x $interested_loc[$random].y}{GUARDIAN}
                [/then]
                [else]
                    [switch]
                        variable=utyp
                        [case]
                            value=1,2,3,4
                            {VARIABLE utype "Ghost"}
                        [/case]
                        [case]
                            value=5,6
                            {VARIABLE utype "Shadow"}
                        [/case]
                        [case]
                            value=7
                            {VARIABLE utype "Spectre"}
                        [/case]
                        [case]
                            value=8,9
                            {VARIABLE utype "Wraith"}
                        [/case]
                    [/switch]
                    {GENERIC_UNIT $enside $utype $interested_loc[$random].x $interested_loc[$random].y}
                [/else]
            [/if]
            {VARIABLE_OP enemies add 1}
        [/do]
    [/while]
    {CLEAR_VARIABLE enemies,my_unit,my_loc,utyp,utype,interested_loc,skels,enside,random,players_vision}
#enddef

    [time_area]
        x=   42,   43,   44,   45,   46,   47
        y=28-33,28-35,26-35,26-37,25-37,25-38
        {DEFAULT_SCHEDULE}
    [/time_area]

    [event]
        name=prestart

        [objectives]
            side=1
            [objective]
                description= _"Get out of the labyrith with $Player1Name and $Player2Name."
                condition=win
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player1Name"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player2Name"
            [/objective]
            {TURNS_RUN_OUT}
        [/objectives]
        [objectives]
            side=2
            [objective]
                description= _"Get out of the labyrinth with $Player1Name and $Player2Name."
                condition=win
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player1Name"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player2Name"
            [/objective]
            {TURNS_RUN_OUT}
        [/objectives]

#ifver WESNOTH_VERSION >= 1.11.0
        [modify_unit]
            [filter]
                side=1,2
            [/filter]
            vision="$($this_unit.max_moves-2)"
        [/modify_unit]
#endif

        {VARIABLE xloc 8}
        {VARIABLE yloc 6}

        {VARIABLE xmax 35}
        {VARIABLE ymax1 29}
        {VARIABLE ymax 57}

        {FOR_VAR yc 0 7 (
            {VARIABLE yloc 6}
            {FOR_VAR xc 0 6 (
                {VARIABLE walls 0}
                [while]
                    {VARIABLE_CONDITIONAL walls less_than 1}
                    [do]
                        {VARIABLE_OP rndm rand 1..4}

                        {VARIABLE xloc_temp $xloc}
                        {VARIABLE yloc_temp $yloc}
                        {VARIABLE xloc_temp4 $xloc}
                        {VARIABLE yloc_temp4 $yloc}

                        [switch]
                            variable=rndm
                            [case]
                                value=1
                                {VARIABLE_OP xloc_temp add -2}
                                {VARIABLE_OP xloc_temp4 add -4}
                            [/case]
                            [case]
                                value=2
                                {VARIABLE_OP xloc_temp add 2}
                                {VARIABLE_OP xloc_temp4 add 4}
                            [/case]
                            [case]
                                value=3
                                {VARIABLE_OP yloc_temp add -2}
                                {VARIABLE_OP yloc_temp4 add -4}
                            [/case]
                            [case]
                                value=4
                                {VARIABLE_OP yloc_temp add 2}
                                {VARIABLE_OP yloc_temp4 add 4}
                            [/case]
                        [/switch]

                        [store_locations]
                            x=$xloc_temp
                            y=$yloc_temp
                            variable=testterrain
                        [/store_locations]

                        {IF_VAR testterrain.terrain not_equals "Xu" (
                            [then]
                                [store_locations]
                                    x=$xloc
                                    y=$yloc
                                    radius=100
                                    [filter_radius]
                                        terrain=Xu
                                        x=6-$xmax
                                        y=4-$ymax1
                                    [/filter_radius]
                                    variable=interested_loc
                                [/store_locations]
                                [store_locations]
                                    find_in=interested_loc
                                    x=$xloc_temp4
                                    y=$yloc_temp4
                                    variable=my_loc
                                [/store_locations]

                                {IF_VAR my_loc.length numerical_equals 0 (
                                    [then]
                                        {VARIABLE xloc_temp2 $xloc_temp}
                                        {VARIABLE yloc_temp2 $yloc_temp}
                                        {VARIABLE yloc_temp3 $yloc_temp}
                                        {VARIABLE_OP xloc_temp2 add 1}
                                        {VARIABLE_OP yloc_temp2 add 1}
                                        {VARIABLE_OP yloc_temp3 add 2}

                                        [terrain]
                                            x=$xloc_temp            ,$xloc_temp2
                                            y=$yloc_temp-$yloc_temp2,$yloc_temp2-$yloc_temp3
                                            terrain=Xu
                                        [/terrain]
                                        {VARIABLE_OP walls add 1}
                                    [/then]
                                )}
                            [/then]
                        )}
                    [/do]
                [/while]

                {VARIABLE walls 0}
                [while]
                    {VARIABLE_CONDITIONAL walls less_than 1}
                    [do]
                        {VARIABLE_OP rndm rand 1..4}

                        {VARIABLE xloc_temp $xloc}
                        {VARIABLE yloc_temp $yloc}
                        {VARIABLE xloc_temp4 $xloc}
                        {VARIABLE yloc_temp4 $yloc}
                        {VARIABLE yloc_temp5 $yloc}

                        [switch]
                            variable=rndm
                            [case]
                                value=1
                                {VARIABLE_OP xloc_temp add -2}
                                {VARIABLE_OP xloc_temp4 add -4}
                            [/case]
                            [case]
                                value=2
                                {VARIABLE_OP xloc_temp add 2}
                                {VARIABLE_OP xloc_temp4 add 4}
                            [/case]
                            [case]
                                value=3
                                {VARIABLE_OP yloc_temp add -2}
                                {VARIABLE_OP yloc_temp4 add -4}
                            [/case]
                            [case]
                                value=4
                                {VARIABLE_OP yloc_temp add 2}
                                {VARIABLE_OP yloc_temp4 add 4}
                            [/case]
                        [/switch]

                        {VARIABLE_OP yloc_temp4 add 28}
                        {VARIABLE_OP yloc_temp5 add 28}
                        {VARIABLE_OP yloc_temp add 28}

                        [store_locations]
                            x=$xloc_temp
                            y=$yloc_temp
                            variable=testterrain
                        [/store_locations]

                        {IF_VAR testterrain.terrain not_equals "Xu" (
                            [then]
                                [store_locations]
                                    x=$xloc
                                    y=$yloc_temp5
                                    radius=100
                                    [filter_radius]
                                        terrain=Xu
                                        x=6-$xmax
                                        y=32-$ymax
                                    [/filter_radius]
                                    variable=interested_loc
                                [/store_locations]
                                [store_locations]
                                    find_in=interested_loc
                                    x=$xloc_temp4
                                    y=$yloc_temp4
                                    variable=my_loc
                                [/store_locations]

                                {IF_VAR my_loc.length numerical_equals 0 (
                                    [then]
                                        {VARIABLE xloc_temp2 $xloc_temp}
                                        {VARIABLE yloc_temp2 $yloc_temp}
                                        {VARIABLE yloc_temp3 $yloc_temp}
                                        {VARIABLE_OP xloc_temp2 add 1}
                                        {VARIABLE_OP yloc_temp2 add 1}
                                        {VARIABLE_OP yloc_temp3 add 2}

                                        [terrain]
                                            x=$xloc_temp            ,$xloc_temp2
                                            y=$yloc_temp-$yloc_temp2,$yloc_temp2-$yloc_temp3
                                            terrain=Xu
                                        [/terrain]

                                        {VARIABLE_OP walls add 1}
                                    [/then]
                                )}
                            [/then]
                        )}
                    [/do]
                [/while]
                {VARIABLE_OP yloc add 4}
            )}
            {VARIABLE_OP xloc add 4}
        )}

        {VARIABLE villages 0}
        [while]
            {VARIABLE_CONDITIONAL villages less_than_equal_to 25}
            [do]
                {VARIABLE_OP xloc rand 6..$xmax}
                {VARIABLE_OP yloc rand 4..$ymax}

                [store_locations]
                    x=$xloc
                    y=$yloc
                    variable=my_loc
                [/store_locations]

                {IF_VAR my_loc.terrain not_equals "Xu" (
                    [then]
                        [terrain]
                            x,y=$xloc,$yloc
                            terrain=Uu^Vu
                        [/terrain]
                        {VARIABLE_OP villages add 1}
                    [/then]
                )}
            [/do]
        [/while]

        {VARIABLE spiders 0}
        [while]
            {VARIABLE_CONDITIONAL spiders less_than_equal_to 8}
            [do]
                {VARIABLE_OP xloc rand(6..$xmax)}
                {VARIABLE_OP yloc rand(4..$ymax)}

                [store_unit]
                    [filter]
                        x=$xloc
                        y=$yloc
                    [/filter]
                    variable=my_unit
                [/store_unit]
                [store_locations]
                    x=$xloc
                    y=$yloc
                    variable=my_loc
                [/store_locations]

                {IF_VAR my_loc.terrain not_equals "Xu" (
                    [then]
                        {IF_VAR my_unit.length numerical_equals 0 (
                            [then]
                                {VARIABLE enside 3}
                                {IF_VAR yloc greater_than 30 (
                                    [then]
                                        {VARIABLE enside 4}
                                    [/then]
                                )}
                                {GENERIC_UNIT $enside ("Giant Spider") $xloc $yloc}{GUARDIAN}
                                {VARIABLE_OP spiders add 1}
                                {CLEAR_VARIABLE enside}
                            [/then]
                        )}
                    [/then]
                )}
            [/do]
        [/while]

        [capture_village]
            y=1-30
            side=3
        [/capture_village]
        [capture_village]
            y=30-999
            side=4
        [/capture_village]
        [redraw][/redraw]

        {CLEAR_VARIABLE villages,spiders,rndm,walls,xloc,yloc,ymax1,my_loc,my_unit,interested_loc}
        {CLEAR_VARIABLE yloc_temp,yloc_temp2,yloc_temp3,yloc_temp4,yloc_temp5}
    [/event]

    [event]
        name=side 1 turn

        [scroll_to]
            x,y=2,5
        [/scroll_to]

        [move_unit_fake]
            type=Human Druid
            side=2
            x=1,1,1,2
            y=8,7,6,6
        [/move_unit_fake]

        [unit]
            type=RfC Human Druid
            role=HumanDruid-Lab
            name= _"Antrem"
            side=2
            x=2
            y=5
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_FEARLESS}
            [/modifications]
            {IS_LOYAL}
        [/unit]

        [unit]
            type=RfC Human Druid
            role=HumanDruid-Lab2
            name= _"Evlak"
            side=1
            x=2
            y=50
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_FEARLESS}
            [/modifications]
            {IS_LOYAL}
        [/unit]
        [redraw]
            clear_shroud=yes
        [/redraw]

        [message]
            role=HumanDruid-Lab
            message= _"Hey dwarf! Me and my brother got lost in this labyrinth. Could you please help us find the way out?"
        [/message]

        [message]
            side=2
            canrecruit=yes
            message= _"We would gladly help you, but we neither know how to get out of here."
        [/message]

        [message]
            role=HumanDruid-Lab
            message= _"But you have an army which can protect you against the undeads in the labyrinth!"
        [/message]

        [message]
            side=2
            canrecruit=yes
            message= _"Then please join us and help us in the fight!"
        [/message]

        [message]
            role=HumanDruid-Lab
            message= _"Thanks, it's very kind of you. Oh, there's one thing you have to know: you can recruit only in this and the next turn, so I suggest calling the best 12 of your fighters as soon as you can!"
        [/message]

        [message]
            side=2
            canrecruit=yes
            message= _"Thank you for the important information! I'll start recalling my fighters immediately."
        [/message]

        [modify_side]
            side=1
            share_maps=no
            share_view=no
        [/modify_side]
        [modify_side]
            side=2
            share_maps=no
            share_view=no
        [/modify_side]
        [redraw]
            clear_shroud=yes
        [/redraw]
        {GENERATE_ENEMIES 40 yes}
    [/event]

    [event]
        name=last breath

        [filter]
            side=1,2
            canrecruit=yes
        [/filter]
        [message]
            speaker=unit
            message=_"I die now, friends... I won't see my homeland any more..."
        [/message]
        [endlevel]
            result=defeat
            reveal_map=no
        [/endlevel]
    [/event]

    [event]
        name=time over

        [message]
            canrecruit=yes
            side=1
            message=_"Oh, no! We have run out of time, didn't manage to get out of this labyrinth..."
        [/message]
        [endlevel]
            result=defeat
            reveal_map=no
        [/endlevel]
    [/event]

    [event]
        name=turn 2 end

        [terrain]
            x= 2,3
            y=47,3
            terrain=Cud
        [/terrain]
    [/event]

    [event]
        name=victory
        {CLEAR_VARIABLE xmax,ymax}
    [/event]

    [event]
        name=side turn end
        first_time_only=no

        [store_reachable_locations]
            [filter]
                side=$side_number
            [/filter]
            variable=visible
        [/store_reachable_locations]

        [store_locations]
            {EVERYWHERE}
            [not]
                find_in=visible
            [/not]
            variable=hidden
        [/store_locations]

        {FOREACH hidden i_temp}
            [place_shroud]
                x,y=$hidden[$i_temp].x,$hidden[$i_temp].y
                side=$side_number
            [/place_shroud]
        {NEXT i_temp}
        {CLEAR_VARIABLE visible,hidden}
        [redraw]
            clear_shroud=yes
        [/redraw]
    [/event]

    [event]
        name=new turn
        first_time_only=no

        [filter_condition]
            {VARIABLE_CONDITIONAL turn_number greater_than 3}
        [/filter_condition]
        {GENERATE_ENEMIES 2 no}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1,2
            canrecruit=yes
            x=42-47
            y=25-38
        [/filter]

        [store_unit]
            variable=escapedUnits
            [filter]
                side=1,2
                canrecruit=yes
                x=42-47
                y=25-38
            [/filter]
        [/store_unit]

        {VARIABLE escapednum $escapedUnits.length}
        {IF_VAR escapednum equals 2 (
            [then]
                [endlevel]
                    result=victory
                    linger_mode=yes
                    bonus=yes
                    carryover_add=no
                    carryover_percentage=40
                    reveal_map=no
                [/endlevel]
            [/then]
        )}
        {CLEAR_VARIABLE escapednum}
        {CLEAR_VARIABLE escapedUnits}
    [/event]

#ifver WESNOTH_VERSION >= 1.11.0
    [event]
        name=prerecruit,prerecall,post advance
        first_time_only=no

        [filter]
        [/filter]

        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]
            vision="$($this_unit.max_moves-2)"
        [/modify_unit]
    [/event]
#endif
[/multiplayer]

#undef FOR_VAR VAR START END FOR_WML
#undef GENERATE_ENEMIES CNT SKELETONS

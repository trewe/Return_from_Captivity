#textdomain wesnoth-Return_from_Captivity

[multiplayer]
    id=CSABI_The_Land_of_the_Dragons
    next_scenario=CSABI_The_Frozen_River
    name= _"RfC-The Land of the Dragons"
    map_data="{~add-ons/Return_from_Captivity/maps/05_The_Land_of_the_Dragons.map}"
    description= _"A multi player campaign for 2 cooperative players. Bring home the elves and dwarfs from the troll prison."
    turns="60"
    victory_when_enemies_defeated=no
    experience_modifier=120%
    allow_new_game=no

    {DEFAULT_SCHEDULE}
    {DEFAULT_MUSIC_PLAYLIST}

    [side]
        id=P1
        save_id=Player_1
        persistent=yes
        type=Elvish Captain
        side=1
        canrecruit=yes
        team_name="Allies"
        user_team_name= _"Allies"
        controller="human"
        team_lock=true
        gold_lock=true
        income_lock=true
        gold=300
        share_maps="yes"
        share_view="yes"
        recruit=Elvish Fighter,Elvish Archer,Mage,Elvish Shaman,Elvish Scout,Merman Fighter,Merman Hunter,Mermaid Initiate
        fog=yes
        village_gold=3
#ifhave campaigns/The_Rise_Of_Wesnoth
        profile="data/campaigns/The_Rise_Of_Wesnoth/images/portraits/logalmier.png"
#endif
    [/side]
    [side]
        id=P2
        save_id=Player_2
        persistent=yes
        type=Dwarvish Steelclad
        side=2
        canrecruit=yes
        team_name="Allies"
        user_team_name= _"Allies"
        controller="human"
        team_lock=true
        gold_lock=true
        income_lock=true
        share_maps="yes"
        share_view="yes"
        gold=300
        recruit=Dwarvish Guardsman,RfC Dwarvish Fighter,Dwarvish Scout,RfC Dwarvish Thunderer,RfC Alchemist,Merman Fighter,Merman Hunter,Mermaid Initiate
        fog=yes
        village_gold=3
#ifhave campaigns/Sceptre_of_Fire
        profile="data/campaigns/Sceptre_of_Fire/images/portraits/durstorn.png"
#endif
        [variables]
            dont_make_me_quick=yes
        [/variables]
    [/side]

    # initial two drakes
    [side] # dwarf side
        type=Inferno Drake
        side=3
        canrecruit=yes
        team_name=drakes
        user_team_name= _"Drakes"
        controller="ai"
        allow_player="no"
        fog=yes
        gold=500
        income=18
        village_gold=4
        recruit=""
        disallow_observers=yes
        [ai]
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 3 main_loop villages}
            aggression=1.0
            village_value=0
            scout_village_targeting=0
            villages_per_scout=0
            [avoid]
                terrain=Rr^Fi|
                radius=1
            [/avoid]
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value=7
            [/goal]
        [/ai]
    [/side]

    [side] # elfish
        type=Drake Blademaster
        side=4
        canrecruit=yes
        team_name=drakes
        user_team_name= _"Drakes"
        controller="ai"
        allow_player="no"
        fog=yes
        gold=500
        income=18
        village_gold=4
        recruit=""
        disallow_observers=yes
        [ai]
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 4 main_loop villages}
            aggression=1.0
            village_value=0
            scout_village_targeting=0
            villages_per_scout=0
            [avoid]
                terrain=Rr^Fi|
                radius=1
            [/avoid]
            [goal]
                [criteria]
                    side=2
                [/criteria]
                value=7
            [/goal]
        [/ai]
    [/side]

    # two more drakes
    [side] # dwarf
        type=Drake Warden
        side=5
        canrecruit=yes
        team_name=drakes
        user_team_name= _"Drakes"
        controller="ai"
        allow_player="no"
        gold=300
        income=-2
        village_gold=4
        fog=yes
        recruit=""
        disallow_observers=yes
        [ai]
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 5 main_loop villages}
            aggression=1.0
            village_value=0
            scout_village_targeting=0
            villages_per_scout=0
            [avoid]
                x=25-40
                y=15-22
            [/avoid]
            [goal]
                [criteria]
                    side=2
                [/criteria]
                value=3
            [/goal]
        [/ai]
    [/side]

    [side] # elfish
        type=Drake Enforcer
        side=6
        canrecruit=yes
        team_name=drakes
        user_team_name= _"Drakes"
        controller="ai"
        allow_player="no"
        fog=yes
        gold=300
        income=-2
        village_gold=4
        recruit=""
        disallow_observers=yes
        [ai]
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 6 main_loop villages}
            aggression=1.0
            village_value=0
            scout_village_targeting=0
            villages_per_scout=0
            [avoid]
                x=25-40
                y=15-22
            [/avoid]
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value=3
            [/goal]
        [/ai]
    [/side]

    # two undead sides
    [side] # dwarf
        type=Lich
        side=7
        canrecruit=yes
        team_name=drakes
        user_team_name= _"Guardians"
        controller="ai"
        allow_player="no"
        gold=0
        income=-2
        recruit=""
        fog=yes
        disallow_observers=yes
        [ai]
            village_value=0.0
            caution=1.0
            {NO_SCOUTS}
            [avoid]
                x=25-40
                y=15-22
            [/avoid]
        [/ai]
    [/side]
    [side] # elfish
        type=Lich
        side=8
        canrecruit=yes
        team_name=drakes
        user_team_name= _"Guardians"
        controller="ai"
        allow_player="no"
        gold=0
        income=-2
        recruit=""
        fog=yes
        disallow_observers=yes
        [ai]
            village_value=0.0
            caution=1.0
            {NO_SCOUTS}
            [avoid]
                x=25-40
                y=15-22
            [/avoid]
        [/ai]
    [/side]

    [side] # Cockatrices
        side=9
        no_leader=yes
        hidden=yes
        controller="ai"
        allow_player="no"
        disallow_observers=yes
        fog=yes
        team_name=drakes
        user_team_name= _"Cockatrices"
        [ai]
            aggression=1.0
            village_value=0
            scout_village_targeting=0
            villages_per_scout=0
            caution=0.0
            {MODIFY_AI_ADD_CANDIDATE_ACTION 9 main_loop (
                [candidate_action]
                    engine=fai
                    id=petrify_attack
                    name=petrify_attack
                    type=attack
                    [filter]
                        me="filter( input, 'me', filter(me.attacks,'att',filter(att.special,'spe',contains_string(spe,'petrifies'))))"
                    [/filter]
                    evaluation="{AI_CA_COMBAT_SCORE}+100+unit_worth
						where unit_worth = target.hitpoints*target.level+max_possible_damage(target,me)"
                    action="attack(me.loc,choose(filter(map(filter(my_moves.moves, src=me.loc),dst),distance_between(self,target.loc) = 1), defense_on(me,self)),target.loc,att_weap)
						where att_weap = index_of(['petrifies'],map(me.attacks,special))"
                [/candidate_action]
            )}
        [/ai]
    [/side]

#define OBJ_SWORD_FIRE X Y ID
    {PLACE_IMAGE items/flame-sword.png {X} {Y}}
    {VARIABLE sword_taken 0}
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1,2
            race=elf
            x,y={X},{Y}
        [/filter]

        [if]
            {VARIABLE_CONDITIONAL sword_taken numerical_equals 0}
            [then]
                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _"Do you want this unit to pick up the sword?"
                    [option]
                        message= _"Yes"
                        [command]
                            [object]
                                id={ID}
                                name= _"Flaming Sword"
                                image=attacks/sword-flaming.png
                                duration=forever
                                description= _"This massive blade was created centuries ago by long-forgotten elvish forgemasters, who imbued the bluish steel with an inner magical fire. Tongues of flame dance on the surface, giving the metal a flawless mirrored finish."
                                [then]
                                    [remove_item]
                                        x,y={X},{Y}
                                    [/remove_item]
                                    [message]
                                        speaker=narrator
                                        image="wesnoth-icon.png"
                                        message= _"As you place your hand around the glittering leather hilt, the sword roars to life! Strangely, you feel no heat once you pick it up, yet the grass at your feet bursts into flame as you test the heft of this mighty weapon."
                                    [/message]
                                    {VARIABLE sword_taken 1}
                                [/then]
                                [effect]
                                    apply_to=new_attack
                                    name=sword
                                    description= _"flaming sword"
                                    icon=attacks/sword-flaming.png
                                    type=fire
                                    range=melee
                                    [specials]
                                        {WEAPON_SPECIAL_MAGICAL}
                                    [/specials]
                                    damage=12
                                    number=4
                                [/effect]

                                # this makes sure that any existing sword attack gets removed
                                [effect]
                                    apply_to=remove_attacks
                                    range=melee
                                    #type=blade
                                    name=sword
                                [/effect]
                                [effect]
                                    apply_to=resistance
                                    replace=true
                                    [resistance]
                                        arcane=140
                                        fire=80
                                    [/resistance]
                                [/effect]
                            [/object]
                        [/command]
                    [/option]
                    [option]
                        message= _"No"
                    [/option]
                [/message]
            [/then]
        [/if]
    [/event]
#enddef

#define OBJ_ROD_OF_JUSTICE X Y ID
    {PLACE_IMAGE items/staff.png {X} {Y}}
    {VARIABLE rod_of_justice 0}
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1,2
            race=dwarf
            x,y={X},{Y}
        [/filter]

        [if]
            {VARIABLE_CONDITIONAL rod_of_justice numerical_equals 0}
            [then]
                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _"Do you want this unit to pick up the staff?"
                    [option]
                        message= _"Yes"
                        [command]
                            [object]
                                id={ID}
                                name= _"Rod of Justice"
                                image="attacks/staff-magic.png"
                                duration=forever
                                description= _"This is a magical staff of tremendous power and unknown origin. The wielder of this staff gains a dramatic increase in strength, speed and intelligence, and is granted the ability to fire devastating lightning bolts at at his opponents. Only a person who is good at heart and who is willing to sacrifice his life on the path of justice can wield this staff."
                                [filter]
                                    id=$unit.id
                                [/filter]

                                [then]
                                    [remove_item]
                                        x,y={X},{Y}
                                    [/remove_item]
                                    {VARIABLE rod_of_justice 1}
                                [/then]

                                # New 16-4 fire attack with cool lightning animation
                                [effect]
                                    apply_to=new_attack
                                    name=rod of justice
                                    description= _"rod of justice"
                                    type=arcane
                                    range=ranged
                                    damage=17
                                    number=3
                                    icon=attacks/lightning.png
                                    [specials]
                                        {WEAPON_SPECIAL_MAGICAL}
                                    [/specials]
                                [/effect]

                                # The cool animation mentioned above, a copypasted fragment from Delfadors attack
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=rod of justice
                                        [/filter_attack]
                                        [missile_frame]
                                            begin=-150
                                            end=0
                                            image=projectiles/lightning-n.png
                                            image_diagonal=projectiles/lightning-ne.png
                                        [/missile_frame]
                                        [if]
                                            hits=no
                                            [frame]
                                                begin=-200
                                                end=0
                                                sound=lightning-miss.ogg
                                            [/frame]
                                        [/if]
                                        [else]
                                            hits=yes
                                            [frame]
                                                begin=-200
                                                end=0
                                                sound=lightning.ogg
                                            [/frame]
                                        [/else]
                                    [/attack_anim]
                                [/effect]

                                [effect]
                                    apply_to=movement
                                    increase=1
                                [/effect]
                                [effect]
                                    apply_to=attack
                                    range=melee
                                    increase_damage=1
                                [/effect]
                                [effect]
                                    apply_to=hitpoints
                                    increase_total=10
                                [/effect]
                                [effect]
                                    apply_to=max_experience
                                    increase=-20%
                                [/effect]
                                [effect]
                                    apply_to=resistance
                                    replace=true
                                    [resistance]
                                        arcane=60
                                        fire=120
                                    [/resistance]
                                [/effect]
                            [/object]
                        [/command]
                    [/option]
                    [option]
                        message= _"No"
                    [/option]
                [/message]
            [/then]
        [/if]
    [/event]
#enddef

    [event]
        name=prestart

        [objectives]
            side=1
            [objective]
                description= _"Reach south-east part of the map."
                condition=win
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player1Name"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player2Name"
            [/objective]
            {TURNS_RUN_OUT}
        [/objectives]
        [objectives]
            side=2
            [objective]
                description= _"Reach south-east part of the map."
                condition=win
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player1Name"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player2Name"
            [/objective]
            {TURNS_RUN_OUT}
        [/objectives]

        {PLACE_IMAGE items/dragonstatue.png 57 28}
        {PLACE_IMAGE items/dragonstatue.png 53 30}
        {PLACE_IMAGE "items/dragonstatue.png~FL(horiz)" 7 3}
        {PLACE_IMAGE "items/dragonstatue.png~FL(horiz)" 4 5}

        {PLACE_IMAGE ("scenery/temple1.png") 33 18}

        {PLACE_IMAGE "items/bones.png" 5 9}
        {PLACE_IMAGE "items/bones.png~FL(horiz)" 14 7}
        {PLACE_IMAGE "items/bones.png~FL(vert)" 14 2}
        {PLACE_IMAGE "items/bones.png~FL(vert)~FL(horiz)" 10 7}
        {PLACE_IMAGE "items/bones.png" 7 7}
        {PLACE_IMAGE "items/bones.png~FL(horiz)" 12 8}
        {PLACE_IMAGE "items/bones.png~FL(vert)" 16 4}
        {PLACE_IMAGE "items/bones.png~FL(vert)~FL(horiz)" 10 4}

        {PLACE_IMAGE ("scenery/signpost.png") 5 4}

        {PLACE_CAPTIVE "units/undead/bloodbat-se-3.png~RC(magenta>red)" 44 2 (Blood Bat) 1 3 no ()}

        {PLACE_CAPTIVE "units/raindancer.png~RC(magenta>red)" 21 3 (RfC Elf Raindancer) 1 2 yes (
            [message]
                type="RfC Elf Raindancer"
                message=_"Thank you for saving us. We will serve you in your battle!"
            [/message]
        )}

        {PLACE_CAPTIVE "units/monsters/spider.png~RC(magenta>red)" 31 6 (Giant Spider) 5 3 no ()}
        {PLACE_CAPTIVE "units/nagas/fighter.png~RC(magenta>blue)" 13 29 (Naga Fighter) 2 3 no ()}
        {PLACE_CAPTIVE "units/monsters/scorpion.png~RC(magenta>blue)" 7 15 (Giant Scorpion) 5 5 no ()}

        {PLACE_CAPTIVE "units/dwarves/gryphon-rider.png~RC(magenta>blue)" 7 25 (RfC_RocRider) 2 2 yes (
            [message]
                type="RfC_RocRider"
                message=_"At last we are out! We'll join you to help you in your fight."
            [/message]
        )}

        {PLACE_COCKATRICE 17 29}
        {PLACE_COCKATRICE 21 22}
        {PLACE_COCKATRICE 31 28}

        {PLACE_COCKATRICE 51 5}
        {PLACE_COCKATRICE 37 2}
        {PLACE_COCKATRICE 41 9}

        {PLACE_STONE_UNIT ("Drake Warrior") 40 2 }
        {PLACE_STONE_UNIT ("Sky Drake") 41 5 }
        {PLACE_STONE_UNIT ("Drake Thrasher") 38 3 }
        {PLACE_STONE_UNIT ("Drake Arbiter") 12 32 }
        {PLACE_STONE_UNIT ("Drake Flare") 12 27 }
        {PLACE_STONE_UNIT ("Fire Drake") 15 25 }

        {VARIABLE opened no}

        {OBJ_SWORD_FIRE 37 16 flame_sword}
        {OBJ_ROD_OF_JUSTICE 29 20 justice_rod}

        [petrify]
            side=3,4,5,6,7,8
        [/petrify]
    [/event]

    [event]
        name=side 1 turn

        [message]
            canrecruit=yes
            side=1
            message=_"This is the end of the forest and here starts a big mountain named Anthillerrac. This is the only road which crosses this high mountain. I've read it in a very old book, which was written by one of my grand grand fathers who was a fanatic traveller."
        [/message]
        [message]
            canrecruit=yes
            side=2
            message=_"The signpost says that this is the land of the dragons and whoever trespasses will die. Did your grand-grand father write anything about those dragons?"
        [/message]
        [message]
            canrecruit=yes
            side=1
            message=_"No, he didn't. He might have thought that this was unimportant."
        [/message]
        [message]
            canrecruit=yes
            side=2
            message=_"Unimportant? We'd better pay attention to this land as I don't like it at all."
        [/message]
    [/event]

    [event]
        name=last breath

        [filter]
            side=1,2
            canrecruit=yes
        [/filter]
        [message]
            speaker=unit
            message=_"I die now, friends... I won't see my homeland any more..."
        [/message]
        [endlevel]
            result=defeat
            reveal_map=no
        [/endlevel]
    [/event]

    [event]
        name=time over

        [message]
            canrecruit=yes
            side=1
            message=_"Oh, no! We have run out of time, reinforcements have arrived..."
        [/message]
        [endlevel]
            result=defeat
            reveal_map=no
        [/endlevel]
    [/event]

    [event]
        name=moveto

        [filter]
            side=1,2
            x,y=5,4
        [/filter]
        [message]
            speaker=narrator
            message=_"Land of the dragoons, don't enter or meet your death."
            image=wesnoth-icon.png
        [/message]
    [/event]

    [event]
        name=prerecruit
        first_time_only=no

        [filter]
            side=3,4,5,6
        [/filter]

        [if]
            {VARIABLE_CONDITIONAL side_$side_number|.$unit.type greater_than_equal_to 3}
            [then]
                [kill]
                    id=$unit.id
                    fire_event=no
                [/kill]

                [disallow_recruit]
                    side=$side_number
                    type=$unit.type
                [/disallow_recruit]
            [/then]
            [else]
                {VARIABLE_OP side_$side_number|.$unit.type add 1}
            [/else]
        [/if]
    [/event]

    [event]
        name=side turn end
        first_time_only=no

        [filter_condition]
            [not]
                [have_unit]
                    side=$side_number
                    canrecruit=yes
                    [status]
                        petrified=yes
                    [/status]
                [/have_unit]
            [/not]
            [and]
                {VARIABLE_CONDITIONAL side_number greater_than 2}
            [/and]
            [and]
                {VARIABLE_CONDITIONAL side_number less_than 7}
            [/and]
        [/filter_condition]

        {CLEAR_VARIABLE side_$side_number}
        [allow_recruit]
            side=$side_number
            type=Drake Burner,Drake Clasher,Drake Glider,Drake Fighter
        [/allow_recruit]
    [/event]

    [event]
        name=moveto

        [filter]
            side=1,2
            x=9-17,3- 9,6-8,8
            y=0-11,6-11,  5,4
        [/filter]
        [message]
            speaker=unit
            message=_"Rather grim place, full of dead bodies."
        [/message]

        [unpetrify]
            side=3,4
        [/unpetrify]

        [set_recruit]
            side=3,4
            recruit="Drake Burner,Drake Clasher,Drake Glider,Drake Fighter"
        [/set_recruit]

        [event]
            name=recruit

            [filter]
                side=3
            [/filter]

            [event]
                name=side 3 turn refresh

                [modify_unit]
                    [filter]
                        side=3
                        canrecruit=no
                    [/filter]
                    moves=16
                [/modify_unit]
            [/event]
        [/event]

        [event]
            name=recruit

            [filter]
                side=4
            [/filter]

            [event]
                name=side 4 turn refresh

                [modify_unit]
                    [filter]
                        side=4
                        canrecruit=no
                    [/filter]
                    moves=12
                [/modify_unit]
            [/event]
        [/event]
    [/event]

    [event]
        name=die

        [filter]
            type=RfC Cockatrice
        [/filter]

        [if]
            [not]
                [have_unit]
                    type=RfC Cockatrice
                    count=5-999
                [/have_unit]
            [/not]
            [then]
                [message]
                    side=7
                    message= _ "Thank you fools! Now we are freed from our wetched curse. As our gratitude now we will kill you all!"
                [/message]

                [modify_side]
                    side=7,8
                    gold=300
                    income=7
                    recruit="Skeleton,Skeleton Archer,Vampire Bat,Ghost,Blood Bat,Wraith,Revenant,Bone Shooter,Deathblade"
                [/modify_side]

                [unpetrify]
                    side=7,8
                [/unpetrify]
            [/then]
        [/if]
    [/event]

    [event]
        name=petrified
        first_time_only=no

        [modify_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            side=9
            canrecruit=no
            hitpoints=$this_unit.max_hitpoints
            zoc=no
            [status]
                petrified=yes
            [/status]
        [/modify_unit]
    [/event]

    {ON_SIGHTING sighted_stoned_drakes (1,2) (type="RfC Cockatrice") (
        # petrified units do not tricker sighted events
        [message]
            speaker="second_unit"
            message=_ "Stone drakes! We'd better be very careful as there are Cockatrices near here. I don't want to be sculpture like this."
        [/message]
    )}

    [event]
        name=moveto

        [filter]
            side=1,2
            x,y=33,18
        [/filter]

        [message]
            speaker=unit
            message=_"What a dark place! Nobody is here."
        [/message]

        {PLACE_IMAGE scenery/rune3-glow.png 44 31}
        {PLACE_IMAGE scenery/rune6-glow.png 57 22}

        [event]
            name=moveto
            first_time_only=no

            [filter]
                side=1,2
                x=44,57
                y=31,22
            [/filter]

            [if]
                {VARIABLE_CONDITIONAL opened equals no}
                [then]
                    [store_unit]
                        variable=runeUnits
                        [filter]
                            side=1,2
                            x=44,57
                            y=31,22
                        [/filter]
                    [/store_unit]

                    [if]
                        {VARIABLE_CONDITIONAL runeUnits.length equals 2}
                        [then]
                            {VARIABLE opened yes}
                            [terrain]
                                x=45,57
                                y=32,23
                                terrain=Re
                            [/terrain]
                            [message]
                                speaker=unit
                                message=_"The walls have opened!"
                            [/message]
                        [/then]
                    [/if]
                    {CLEAR_VARIABLE runeUnits}
                [/then]
            [/if]
        [/event]

        [message]
            speaker=unit
            message=_"Hey, I've found how to open the walls to get out of here! If two units step onto the runes, the walls will open."
        [/message]
    [/event]

    [event]
        name=moveto

        [filter]
            side=1,2
            x=7-20
            y=27-33
        [/filter]

        [unpetrify]
            side=5
        [/unpetrify]

        [modify_side]
            side=5
            income=14
        [/modify_side]

        [set_recruit]
            side=5
            recruit="Drake Burner,Drake Clasher,Drake Glider,Drake Fighter"
        [/set_recruit]

        [event]
            name=side 5 turn end

            [event]
                name=side 5 turn refresh

                [modify_unit]
                    [filter]
                        side=5
                        canrecruit=no
                    [/filter]
                    moves=10
                [/modify_unit]
            [/event]
        [/event]
    [/event]

    [event]
        name=moveto

        [filter]
            side=1,2
            x=45-60
            y=1-10
        [/filter]

        [unpetrify]
            side=6
        [/unpetrify]

        [modify_side]
            side=6
            income=14
        [/modify_side]

        [set_recruit]
            side=6
            recruit="Drake Burner,Drake Clasher,Drake Glider,Sky Drake,Drake Fighter"
        [/set_recruit]

        [event]
            name=side 6 turn end

            [event]
                name=side 6 turn refresh

                [modify_unit]
                    [filter]
                        side=6
                        canrecruit=no
                    [/filter]
                    moves=10
                [/modify_unit]
            [/event]
        [/event]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1,2
            canrecruit=yes
            x=53-60,54-60,56-60
            y=30-32,   29,27-28
        [/filter]

        [store_unit]
            [filter]
                side=1,2
                canrecruit=yes
                x=53-60,54-60,56-60
                y=30-32,   29,27-28
            [/filter]
            variable=escapedUnits
        [/store_unit]

        [if]
            {VARIABLE_CONDITIONAL escapedUnits.length equals 2}
            [then]
                [endlevel]
                    result=victory
                    linger_mode=yes
                    bonus=yes
                    carryover_add=no
                    carryover_percentage=40
                [/endlevel]
            [/then]
        [/if]
        {CLEAR_VARIABLE escapedUnits}
    [/event]

    [event]
        name=victory,defeat
        {CLEAR_VARIABLE opened}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter_condition]
            [not]
                [have_unit]
                    type=Nightgaunt
                    side=9
                [/have_unit]
            [/not]
        [/filter_condition]

        [filter]
            side=1,2
            [filter_location]
                terrain=Rr^Fi*
                radius=1
            [/filter_location]
            [not]
                [filter_location]
                    terrain=Tf
                    radius=4
                [/filter_location]
            [/not]
            [not]
                [filter_location]
                    terrain=Ch
                    radius=2
                [/filter_location]
            [/not]
        [/filter]

        [terrain]
            x=14,15,16,50,51,52,53
            y=9,9,8,27,27,26,27
            terrain=Qxu
        [/terrain]

        {LOYAL_UNIT 9 Nightgaunt $x1 $y1}
        {LOYAL_UNIT 9 Nightgaunt $x1 $y1}
        {LOYAL_UNIT 9 Nightgaunt $x1 $y1}

        [message]
            side=9
            type=Nightgaunt
            message=_"You've entered a holy place! The punishment for you is death."
        [/message]

        [kill]
            side=1,2
            x=14,15,16,50,51,52,53
            y=9,9,8,27,27,26,27
            animate=yes
            fire_event=yes
        [/kill]
    [/event]

    [event]
        name=moveto

        [filter]
            side=1,2
            x=36-38,34-39,32-37,30-35,28-33,27-31,29
            y=   15,   16,   17,   18,   19,   20,21
        [/filter]

        {NOTRAIT_UNIT 6 Lich 31 17}
        {NOTRAIT_UNIT 6 Lich 35 19 }
        {NOTRAIT_UNIT 6 Revenant 32 16 }
        {NOTRAIT_UNIT 6 Revenant 30 17 }
        {NOTRAIT_UNIT 6 Revenant 30 16 }
        {NOTRAIT_UNIT 6 Revenant 36 18 }
        {NOTRAIT_UNIT 6 Revenant 34 19 }
        {NOTRAIT_UNIT 6 Revenant 36 19 }
        {NOTRAIT_UNIT 6 Deathblade 31 16 }
        {NOTRAIT_UNIT 6 Deathblade 29 17 }
        {NOTRAIT_UNIT 6 Deathblade 35 20 }
        {NOTRAIT_UNIT 6 Deathblade 37 19 }

        [message]
            side=6
            type=Lich
            message=_"You've entered a holy place! The punishment for you is death."
        [/message]
    [/event]

    [event]
        name=recruit
        first_time_only=no

        [filter]
            side=3,4,5,6
        [/filter]

        [if]
            {VARIABLE_CONDITIONAL unit.max_moves greater_than 6}
            [then]
                [object]
                    silent=yes
                    [filter]
                        id=$unit.id
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_SKIRMISHER}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=loyal
                    [/effect]
                [/object]
            [/then]
            [else]
                [object]
                    silent=yes
                    [filter]
                        id=$unit.id
                    [/filter]
                    [effect]
                        apply_to=movement
                        increase=2
                    [/effect]
                [/object]
            [/else]
        [/if]

        {RANDOM 20..130}
        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]
            experience="$($this_unit.experience+$random)"
        [/modify_unit]

        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]
            experience=0
        [/modify_unit]
        {CLEAR_VARIABLE random}
    [/event]
[/multiplayer]

#undef OBJ_SWORD_FIRE X Y ID
#undef OBJ_ROD_OF_JUSTICE X Y ID
